<header class="header">
  <h1>Traffic Counter</h1>
  <div class="header-actions">
    <button (click)="addMeasurement()">New Measurement</button>
    <button (click)="clearAll()" [disabled]="measurements().length === 0">Clear All</button>
    <button (click)="toggleTheme()">{{ isDarkMode() ? 'Light Mode' : 'Dark Mode' }}</button>
  </div>
</header>

<main class="main">
  @if (measurements().length > 0) {
    <div class="total-vehicles">
      <h2>Total Vehicles: {{ totalVehicles() }}</h2>
    </div>

    <!-- Overall Flow Statistics -->
    <div class="overall-flow-container">
      <h3>Overall Vehicle Flow</h3>
      <div class="time-range-selectors">
        <div class="selector">
          <label for="startTime">Start Time:</label>
          <select id="startTime" [(ngModel)]="selectedStartTime">
            <option value="">-- Select --</option>
            @for(time of timeSlots; track time) {
              <option [value]="time">{{ time }}</option>
            }
          </select>
        </div>
        <div class="selector">
          <label for="endTime">End Time:</label>
          <select id="endTime" [(ngModel)]="selectedEndTime">
            <option value="">-- Select --</option>
            @for(time of timeSlots; track time) {
              <option [value]="time">{{ time }}</option>
            }
          </select>
        </div>
      </div>
      @if(selectedStartTime() && selectedEndTime() && selectedStartTime() < selectedEndTime()){
        <div class="overall-flow-result">
          <h4>{{ overallFlow() }}</h4>
          <span>vehicles/hour</span>
        </div>
      }
    </div>

    <app-chart [data]="chartData()"></app-chart>

    <div class="measurement-list" [@listAnimation]="measurements().length">
      @for (measurement of measurements(); track measurement.id) {
        <div class="measurement-card" 
             [class.active-measurement]="measurement.endTime === null" 
             [@itemAnimation]>
          <div class="measurement-header">
            <div>
              <h2>Measurement #{{ measurement.id }}</h2>
              @if (measurement.endTime) {
                <span>{{ measurement.startTime | date:'mediumTime' }} - {{ measurement.endTime | date:'mediumTime' }}</span>
              } @else {
                <span>{{ measurement.startTime | date:'mediumTime' }} - Present</span>
              }
            </div>
            <div class="flow-rate">
              <h4>{{ getFlowRate(measurement) }}</h4>
              <span>vehicles/hour</span>
            </div>
          </div>
          <div class="counters">
            <app-counter [label]="'Trucks'" [count]="measurement.trucks" (increment)="increment(measurement.id, 'trucks')"></app-counter>
            <app-counter [label]="'Cars'" [count]="measurement.cars" (increment)="increment(measurement.id, 'cars')"></app-counter>
            <app-counter [label]="'Motorcycles'" [count]="measurement.motorcycles" (increment)="increment(measurement.id, 'motorcycles')"></app-counter>
            <app-counter [label]="'Bicycles'" [count]="measurement.bicycles" (increment)="increment(measurement.id, 'bicycles')"></app-counter>
          </div>
        </div>
      }
    </div>
  } @else {
    <div class="no-measurements">
      <p>No measurements yet. Click "New Measurement" to start counting.</p>
    </div>
  }
</main>

@if (pwaService.isInstallable()) {
  <app-install-prompt 
    (install)="installPwa()" 
    (dismiss)="dismissPwaPrompt()"
  ></app-install-prompt>
}
